<?php
$title = $this->translate('Shipping configuration');
$this->headTitle($title);
$this->placeholder('headerContent')->set($title);

$this->headScript()->appendFile($this->websiteUrl.'plugins/shopping/web/js/libs/require.min.js', null, array('data-main' => $this->websiteUrl.'plugins/shopping/web/js/shipping.js'));

?>

<div class="content-footer">
    <form id="general-config" class="grid_12">
        <div class="grid_10 alpha omega">
            <label class="pointer" for="config-checkoutShippingTocRequire">
                <?php echo $this->formCheckbox('config[' . Shopping::SHIPPING_TOC_STATUS . ']', null, array('checked' => isset($this->shoppingConfig[Shopping::SHIPPING_TOC_STATUS]) ? $this->shoppingConfig[Shopping::SHIPPING_TOC_STATUS] : false)); ?>
                <?php echo $this->translate('Require Shipping TOC on checkout. Use label (HTML ok):'); ?>
            </label>
            <?php echo $this->formText(
                'config[' . Shopping::SHIPPING_TOC_LABEL . ']',
                isset($this->shoppingConfig[Shopping::SHIPPING_TOC_LABEL]) ? $this->shoppingConfig[Shopping::SHIPPING_TOC_LABEL] : null,
                array(
                    'placeholder' => $this->translate('left empty to use autogenerated label'),
                    'class'       => 'grid_4 alpha'
                )); ?>
            <?php echo $this->formText(
                'config[' . Shopping::SHIPPING_SUCCESS_MESSAGE . ']',
                isset($this->shoppingConfig[Shopping::SHIPPING_SUCCESS_MESSAGE]) ? $this->shoppingConfig[Shopping::SHIPPING_SUCCESS_MESSAGE] : null,
                array(
                    'placeholder' => $this->translate('Success message at the checkout page'),
                    'class'       => 'grid_4 alpha'
                )); ?>
            <?php echo $this->formText(
                'config[' . Shopping::SHIPPING_ERROR_MESSAGE . ']',
                isset($this->shoppingConfig[Shopping::SHIPPING_ERROR_MESSAGE]) ? $this->shoppingConfig[Shopping::SHIPPING_ERROR_MESSAGE] : null,
                array(
                    'placeholder' => $this->translate('Error message at the checkout page'),
                    'class'       => 'grid_4 alpha'
                )); ?>
        </div>
        <div class="grid_2 alpha omega mt0px">
            <label for="config-shippingTaxRate"><?php echo $this->translate('Shipping Tax Rate'); ?></label>
            <select name="<?php echo 'config['.Shopping::SHIPPING_TAX_RATE.']';?>">
                <option value="0" <?php echo (isset($this->shoppingConfig[Shopping::SHIPPING_TAX_RATE]) && $this->shoppingConfig[Shopping::SHIPPING_TAX_RATE] === '0') ? 'selected' : '';?>><?php echo $this->translate('Select');?></option>
                <option value="1" <?php echo (isset($this->shoppingConfig[Shopping::SHIPPING_TAX_RATE]) && $this->shoppingConfig[Shopping::SHIPPING_TAX_RATE] === '1') ? 'selected' : '';?>><?php echo $this->translate('Default Tax');?></option>
                <option value="2" <?php echo (isset($this->shoppingConfig[Shopping::SHIPPING_TAX_RATE]) && $this->shoppingConfig[Shopping::SHIPPING_TAX_RATE] === '2') ? 'selected' : '';?>><?php echo $this->translate('Tax Rate 1');?></option>
                <option value="3" <?php echo (isset($this->shoppingConfig[Shopping::SHIPPING_TAX_RATE]) && $this->shoppingConfig[Shopping::SHIPPING_TAX_RATE] === '3') ? 'selected' : '';?>><?php echo $this->translate('Tax Rate 2');?></option>
            </select>
        </div>
    </form>
    <div id="shipping-config" class="grid_12 mt15px">
        <div id="shippers" class="ui-tabs-vertical clearfix">
            <ul class="grid_4 alpha omega list-bordered scroll m0px">
                <li><a href="#markup" data-plugin="markup"><?php echo $this->translate('Markup'); ?></a></li>
                <li><a href="#pickup" data-plugin="pickup"><?php echo $this->translate('Pickup'); ?></a></li>
                <li><a href="#freeshipping" data-plugin="freeshipping"><?php echo $this->translate('Free shipping'); ?></a></li>
            <?php foreach($this->shippingPlugins as $plugin): ?>
                <li><a data-plugin="<?php echo $plugin->getName(); ?>" href="<?php echo $this->url(array('run' => 'config', 'name' => strtolower($plugin->getName())), 'pluginroute'); ?>"><?php echo $plugin->getName(); ?></a></li>
            <?php endforeach; ?>
            </ul>
            <div id="pane-container" class="grid_8 omega scroll">
            <div id="markup">
                <?php $this->markupForm->setAction($this->url(array('run' => 'bundledshipper'))); ?>
                <form action="<?php echo $this->markupForm->getAction(); ?>" method="post" enctype="application/x-www-form-urlencoded">
                    <?php echo $this->markupForm->getElement('shipper')->renderViewHelper(); ?>
                    <fieldset class="background">
                        <legend class="background large p5px"><?php echo $this->translate('Shipping markup configuration'); ?></legend>
                        <p class="labeled">
                            <?php echo $this->markupForm->getElement('modifierType')->setAttrib('class', 'grid_2 alpha fl-right')->renderViewHelper(); ?>
                            <?php echo $this->markupForm->getElement('price')->setAttrib('class', 'grid_4 fl-right')->renderViewHelper(); ?>
                            <?php echo $this->markupForm->getElement('modifierSign')->setAttrib('class', 'grid_2 omega fl-right')->renderViewHelper(); ?>
                            <label class="grid_4 omega" for="cartamount"><?php echo $this->markupForm->getElement('price')->getLabel(); ?></label>
                        </p>
                    </fieldset>
                 </form>
            </div>
            <div id="pickup">
                <label class="message info"><?php echo $this->translate('When this option is checked user will be given the option to pick their stuff up at your store location.'); ?></label>
            </div>
            <div id="freeshipping">
                <?php $this->freeForm->setAction($this->url(array('run' => 'bundledshipper'))); ?>
                <form class="clearfix" action="<?php echo $this->freeForm->getAction(); ?>" method="post" enctype="application/x-www-form-urlencoded">
                    <?php echo $this->freeForm->getElement('shipper')->renderViewHelper(); ?>
                    <fieldset class="background">
                        <legend class="background large p5px"><?php echo $this->translate('Free shipping'); ?></legend>
                        <p class="grid_6 alpha omega suffix_1 mt0px labeled">
                            <label class="unit-over grid_2 alpha omega fl-right"><?php echo $this->config['currency']; ?></label>
                            <?php echo $this->freeForm->getElement('cartamount')->setAttrib('class', 'grid_5 alpha omega fl-right')->renderViewHelper(); ?>
                            <label class="grid_5 alpha omega" for="cartamount"><?php echo $this->freeForm->getElement('cartamount')->getLabel(); ?></label>
                        </p>
                        <p class="grid_5 omega mt0px labeled">
                            <?php echo $this->freeForm->getElement('destination')->setAttrib('class', 'grid_7 alpha omega fl-right')->renderViewHelper(); ?>
                            <label class="grid_5 alpha omega"><?php echo $this->freeForm->getElement('destination')->getLabel(); ?></label>
                        </p>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<div class="footer grid_12">
    <?php echo $this->formButton('submit', 'Save', array('class' => 'btn icon-save', 'type' => 'submit')); ?>
</div>

<script>
$(function(){
    $('form#general-config :input').on('change', function(){
        $.post($('#website_url').val()+'plugin/shopping/run/setConfig', $(this).closest('form').serialize());
    });

    $('#shippers').tabs({
        idPrefix      : 'shipper-tab',
        panelTemplate : '<div class="clearfix"></div>',
        beforeLoad    : function(event, ui){
            showSpinner('#pane-container');
        }
    });

    $('.footer #submit').on('click', function(){
        showSpinner();
        var index = $('#shippers').tabs("option", "active"), currentPane = $('#pane-container div.ui-tabs-panel:eq('+index+')');
        if(currentPane){
            var form = currentPane.find('form');
            $.ajax({
                url      : form.attr('action'),
                data     : form.serialize(),
                dataType : 'json',
                type     : form.attr('method'),
                complete : function(response){
                    form.trigger('formsave', response);
                    hideSpinner();
                }
            });
        }
    });
});
</script>