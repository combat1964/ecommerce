if(_.isUndefined(TFilter)){var TFilter={},AttributesCollection=Backbone.Collection.extend({url:function(){return $("#website_url").val()+"api/filtering/filters/"}});TFilter.Attributes=new AttributesCollection;TFilter.MainView=Backbone.View.extend({tags:[],events:{"change .filtering-attribute-widget input":"saveAttributeValue","keyup [name=new-attribute]":"attachAttribute","click .filed-upgrade-select input":"changeAttributeStatus"},initialize:function(){this.productId=this.$el.data("productid");this.$tabs=
this.$el.find("div.plugin-filtering-builder-content");this.$tabs.tabs();this.$tabs.on("tabsactivate",_.bind(this.initTagsBlock,this));this.data=this.$el.data();var a=this;this.$el.find("input.typeahead").autocomplete({source:_.bind(this.autocomplete,this),select:function(c,b){$(".filtering-attribute-widget").show();$(".add-new-config").hide();a.renderAttribute(b.item).find("input:text").focus();$(this).val("").blur();return!1}})},setTags:function(a){_.isEmpty(a)||(this.tags=a);return this},getTags:function(){return this.tags},
changeAttributeStatus:function(a){var c=$(a.currentTarget).closest(".filed-upgrade-select").find(".checkbox"),b=$(a.currentTarget).closest(".filtering-attribute-widget");a=c.val();var d=b.attr("data-attributeId"),b=b.attr("data-attributeValue"),e=this.productId,f="",f=c.is(":checked")?!0:!1,c={product_id:e,attribute_id:d,tagId:a,attributeVal:b,checked:f};$.ajax({url:$("#website_url").val()+"api/filtering/eav/",type:"PUT",data:JSON.stringify(c),success:function(a){showMessage(a.responseText.message,
!1,2E3)}})},attachAttribute:function(a){a.preventDefault();if(13===a.keyCode){var c=this,b=$(a.currentTarget),d=b.val(),e=[];a=TFilter.Attributes.find(function(a){return a.get("label")===d});_.each(this.$el.find(".apply-to-tags input:checkbox:checked"),function(a){e.push($(a).val())});if(a){b.val("");var f=this.$el.find('.product-filters-list input[name="'+a.get("name")+'"]');f.size()?f.focus():c.renderAttribute(_.extend({tags:e},a.toJSON())).find("input:text").focus()}else TFilter.Attributes.create({label:d},
{success:function(a,d){b.val("").blur();var f={attribute_id:a.get("id"),label:a.get("label"),name:a.get("name"),tags:e};c.renderAttribute(f).find("input:text").focus()},error:function(a,b){showMessage(b.responseText,!0)}})}},initTagsBlock:function(){var a="";_.isEmpty(this.tags)?a="<label>This product has no tags yet</label>":_.each(this.tags,function(c){a+='<label><input type="checkbox" name="tags[]" value="'+c.id+'" />'+_.escape(c.name)+"</label>"});this.$el.find(".apply-to-tags").html(a)},loadAttributes:function(a){_.isEmpty(a)||
_.each(a,this.renderAttribute,this)},renderAttribute:function(a,c){var b=this.$el.find('input[name="'+a.name+'"]'),d=[];if(b.size())return b.closest("p.filtering-attribute-widget");_.isUndefined(this.list)&&(this.list=this.$el.find(".product-filters-list"));_.has(a,"tags")&&(d=a.tags);var e="";_.each(a.tags,function(b,c){e=-1!==$.inArray(b,a.checked_Tags)?e+('<label class="filed-upgrade-select"><input class="checkbox" type="checkbox" checked name="tags[]" value="'+b+'" />'+_.escape(c)+"</label>"):
e+('<label class="filed-upgrade-select"><input class="checkbox" type="checkbox" name="tags[]" value="'+b+'" />'+_.escape(c)+"</label>")});var f=b="";a.product_id&&(b="ticon-cog",f="ticon-remove-sign");return $("<p>",{"class":"filtering-attribute-widget","data-attributeId":a.attribute_id,"data-attributeValue":a.value,"data-productId":a.product_id}).append($("<label>").html(a.label+" ").append($("<span>",{"class":f,style:"color:#FF6347;"}))).append($("<input>",{type:"text",name:a.name,value:_.unescape(a.value)}).data({aid:a.attribute_id,
tags:d})).append($("<span>",{"class":b,style:"color:#228B22;"}).html("")).append($("<div>",{"class":"updateConfigBlock",style:"display:none;"}).append(e)).appendTo(this.list)},saveAttributeValue:function(a){var c=$(a.currentTarget);a={product_id:this.productId,attribute_id:c.data("aid"),tags:c.data("tags"),value:c.val()};""!==a.value&&$.ajax({url:$("#website_url").val()+"api/filtering/eav/",type:"PUT",data:JSON.stringify(a),success:function(a){c.val(_.unescape(a.value));document.location.reload(!0)}})},
autocomplete:function(a,c){var b=$.ui.autocomplete.escapeRegex(a.term).toLowerCase(),d=_.chain(TFilter.Attributes.toJSON()).filter(function(a){return-1!==a.label.toLowerCase().search(b)}).map(function(a){return{attribute_id:a.id,name:a.name,label:a.label,value:null}}).value();c(d)}});$(function(){TFilter.Attributes.fetch()})};
